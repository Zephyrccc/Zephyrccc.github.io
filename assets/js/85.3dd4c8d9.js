(window.webpackJsonp=window.webpackJsonp||[]).push([[85],{409:function(e,a,s){"use strict";s.r(a);var t=s(4),r=Object(t.a)({},(function(){var e=this,a=e._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"htaccess文件利用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#htaccess文件利用"}},[e._v("#")]),e._v(" .htaccess文件利用")]),e._v(" "),a("h2",{attrs:{id:"apache调用解析器的三种方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#apache调用解析器的三种方式"}},[e._v("#")]),e._v(" Apache调用解析器的三种方式")]),e._v(" "),a("p",[a("strong",[e._v("在普遍使用的LAMP架构中，Apache与PHP之间的交互，有三种常见的方式。")])]),e._v(" "),a("ul",[a("li",[e._v("第一种是最通用最常见的Module方式，即在httpd.conf中使用LoadModule的方式，将php的dll或者so文件加载到apache当中")]),e._v(" "),a("li",[e._v("还有两种是CGI方式和FastCGI方式。其实后者用的越来越广泛了。一般PHP-FPM也是与FastCGI进行配合使用的")]),e._v(" "),a("li",[e._v("可以参考"),a("a",{attrs:{href:"https://www.awaimai.com/371.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("CGI、FastCGI和PHP-FPM关系图解"),a("OutboundLink")],1)])]),e._v(" "),a("h2",{attrs:{id:"cgi启动方式的rce利用姿势"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cgi启动方式的rce利用姿势"}},[e._v("#")]),e._v(" CGI启动方式的RCE利用姿势")]),e._v(" "),a("p",[e._v("当我们了解原理后，Apache是需要调用第三方CGI程序，但是一个程序是不是CGI程序这个事很难界定，我们能否通过调用特定的CGI程序(普通程序)来执行任意系统命令呢，答案是可以的")]),e._v(" "),a("h3",{attrs:{id:"利用条件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#利用条件"}},[e._v("#")]),e._v(" 利用条件")]),e._v(" "),a("ol",[a("li",[e._v("保证htaccess会被解析，即当前目录中配置了AllowOverride all或AllowOverride Options FileInfoAllowOverride参数具体作用可参考Apache之AllowOverride参数详解(Require all granted也是需要的)")]),e._v(" "),a("li",[e._v("cgi_module被加载。即apache配置文件中有LoadModule cgi_module modules/mod_cgi.so这么一句且没有被注释")]),e._v(" "),a("li",[e._v("有目录的上传、写入权限")])]),e._v(" "),a("h3",{attrs:{id:"利用姿势"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#利用姿势"}},[e._v("#")]),e._v(" 利用姿势")]),e._v(" "),a("p",[e._v("上传.htaccess 文件, 内容如下")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("Options ExecCGI\nAddHandler cgi-script .xx\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("Options ExecCGI表示允许CGI执行，如果AllowOverride只有FileInfo权限且本身就开启了ExecCGI的话，就可以不需要这句话了")]),e._v(" "),a("p",[e._v("第二句告诉Apache将xx后缀名的文件，当做CGI程序进行解析")]),e._v(" "),a("p",[e._v("接下来，以Windows平台为例，上传poc.xx文件，内容如下：")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("#!C:/Windows/System32/cmd.exe /c start calc.exe\n1\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("第一行用来表示CGI程序的路径。可以随便开你的脑洞")]),e._v(" "),a("p",[e._v("因为CGI程序处理完成后，会被Apache关闭，所以我们这里要用启动新进程的方式来启动")]),e._v(" "),a("p",[e._v("结果，这时访问poc.xx，计算器就出来了")]),e._v(" "),a("p",[e._v("拿火绒剑来看下")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/Zephyrccc/ImageHostingService/Blog/htaccess001.png",alt:"htaccess001"}})]),e._v(" "),a("p",[e._v("一目了然，读取了两个文件后，httpd.exe的mod_cgi.so模块执行了我们的命令")]),e._v(" "),a("p",[e._v("linux环境下，也是随你玩，是直接调用/bin/bash还是调用/usr/bin/python来反弹Shell。都是可以的。这其实也就是正常使用方式，因为Python也会被用作为CGI解析程序")]),e._v(" "),a("h2",{attrs:{id:"fastcgi启动方式的rce利用姿势"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fastcgi启动方式的rce利用姿势"}},[e._v("#")]),e._v(" FastCGI启动方式的RCE利用姿势")]),e._v(" "),a("p",[e._v("我们再来看看FastCGI模式的，这个依赖的是mod_fcgid.so，默认安装包里甚至没有这个so文件，不过在PHPStudy的默认配置中，就已经是加载了的，并且AllowOverride也是All权限，手动斜眼")]),e._v(" "),a("p",[e._v("其实还有mod_proxy_fcgi，更为常见，也是默认开启的，还不清楚能否利用，可以自行尝试一下")]),e._v(" "),a("h3",{attrs:{id:"利用条件-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#利用条件-2"}},[e._v("#")]),e._v(" 利用条件")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("AllowOverride all或AllowOverride Options FileInfo")])]),e._v(" "),a("li",[a("p",[e._v("mod_fcgid.so被加载。即apache配置文件中有LoadModule fcgid_module modules/mod_fcgid.so")])]),e._v(" "),a("li",[a("p",[e._v("有目录的上传、写入权限")])])]),e._v(" "),a("h3",{attrs:{id:"利用姿势-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#利用姿势-2"}},[e._v("#")]),e._v(" 利用姿势")]),e._v(" "),a("p",[e._v("上传.htaccess 文件, 内容如下：")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('Options +ExecCGI\nAddHandler fcgid-script .abc\nFcgidWrapper "C:/Windows/System32/cmd.exe /c start cmd.exe" .abc\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("p",[e._v("老样子，如果默认就开启了ExecCGI，则第一句可以省略")]),e._v(" "),a("p",[e._v("第二句表示，abc后缀名的文件需要被fcgi来解析。AddHandler还可以换成AddType")]),e._v(" "),a("p",[e._v("再上传1.abc。内容无所谓")]),e._v(" "),a("p",[e._v("结果，访问1.abc，计算器就出来了，再拿火绒剑看下")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/Zephyrccc/ImageHostingService/Blog/htaccess002.png",alt:"htaccess002"}})]),e._v(" "),a("p",[e._v("tips：若拥有上传权限，以上两种利用方式，在PHPstudy默认配置当中，都是可以直接使用的")]),e._v(" "),a("h3",{attrs:{id:"使用相对路径"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用相对路径"}},[e._v("#")]),e._v(" 使用相对路径")]),e._v(" "),a("p",[e._v("其实一些小伙伴也已经发现了，上面的问题再配合有上传漏洞，我甚至可以传个🐎上去。但是无论是CGI还是FastCGI似乎都是绝对路径，相对路径可不可以呢")]),e._v(" "),a("p",[e._v("经过了一些尝试，并请教了”裤衩哥”,发现相对路径也是可以的，起始点似乎和session.save_path变量的值是一致的。如图，比如phpstudy当中，起始点就是在\\Extensions\\tmp\\tmp中")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/Zephyrccc/ImageHostingService/Blog/htaccess003.png",alt:"htaccess003"}})]),e._v(" "),a("p",[e._v("那么，比如说我想要html后缀使用php来解析。就可以这样写")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('AddHandler fcgid-script .html\nFcgidWrapper "../../php/php7.3.4nts/php-cgi.exe" .html\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("再来，我想调用网站根目录的calc.exe。可以这样")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('AddHandler fcgid-script .xx\nFcgidWrapper "../../../WWW/localhost/calc.exe" .xx\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("不过计算器无法正常弹出。猜应该是因为calc毕竟不是个标准CGI程序导致的吧。而且也没必要绕这么大个圈子，就没继续测试了")]),e._v(" "),a("h2",{attrs:{id:"其他常规利用姿势"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他常规利用姿势"}},[e._v("#")]),e._v(" 其他常规利用姿势")]),e._v(" "),a("h3",{attrs:{id:"将特定文件作为php解析-用作后门"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#将特定文件作为php解析-用作后门"}},[e._v("#")]),e._v(" 将特定文件作为php解析，用作后门")]),e._v(" "),a("p",[e._v("Module模式下写法如下：")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("AddType application/x-httpd-php .jpg\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("或")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('  <FilesMatch "test.jpg">\n    SetHandler application/x-httpd-php\n  </FilesMatch>\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("p",[e._v("甚至可以将 .htaccess本身作为php来解析，里面编写一句话。这块网络上相关资料很多")]),e._v(" "),a("h3",{attrs:{id:"php环境下使用-auto-prepend-file-或-auto-append-file-创建后门"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#php环境下使用-auto-prepend-file-或-auto-append-file-创建后门"}},[e._v("#")]),e._v(" PHP环境下使用 auto_prepend_file 或 auto_append_file 创建后门")]),e._v(" "),a("p",[e._v("通过配置auto_append_file或auto_prepend_file可以向所有php文件中的开头或尾部插入指定的文件的内容")]),e._v(" "),a("p",[e._v("在. htaccess中的写入如下：")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('php_value auto_prepend_file "/home/fdipzone/header.php"\nphp_value auto_append_file "/home/fdipzone/footer.php"\n')])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("对于CGI/FastCGI模式 PHP 5.3.0 以上版本，还可以使用 在目录下创建.user.ini文件 。来引入该参数。写法如下：")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("auto_prepend_file = hackdoor.gif\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[a("a",{attrs:{href:"https://www.cnblogs.com/anbuxuan/p/11867129.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("原文链接"),a("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=r.exports}}]);